{% extends "base.html" %}

{% block title %}Manage Users - AutoAssess Admin{% endblock %}

{% block content %}
<section class="min-h-screen px-4 sm:px-6 lg:px-8 py-12">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-12 slide-in">
            <div>
                <h1 class="text-4xl lg:text-5xl font-bold text-white mb-2">
                    User <span class="bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Management</span>
                </h1>
                <p class="text-xl text-white/80">Manage all registered users</p>
            </div>
            <a href="{{ url_for('admin') }}" 
               class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 inline-flex items-center">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Dashboard
            </a>
        </div>

        {% if data %}
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-12">
                <div class="glass-effect rounded-2xl p-6 text-center slide-in">
                    <div class="text-3xl font-bold text-blue-400 mb-2">{{ data|length }}</div>
                    <div class="text-white/80">Total Users</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center slide-in" style="animation-delay: 0.1s;">
                    <div class="text-3xl font-bold text-green-400 mb-2">{{ data|selectattr('user_status', 'equalto', 'approved')|list|length }}</div>
                    <div class="text-white/80">Approved</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center slide-in" style="animation-delay: 0.2s;">
                    <div class="text-3xl font-bold text-yellow-400 mb-2">{{ data|selectattr('user_status', 'equalto', 'Pending')|list|length }}</div>
                    <div class="text-white/80">Pending</div>
                </div>
                <div class="glass-effect rounded-2xl p-6 text-center slide-in" style="animation-delay: 0.3s;">
                    <div class="text-3xl font-bold text-purple-400 mb-2">{{ data|selectattr('gender', 'equalto', 'M')|list|length }}</div>
                    <div class="text-white/80">Male Users</div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="glass-effect rounded-3xl p-8 slide-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white">
                        <i class="fas fa-users mr-2"></i>
                        All Users
                    </h2>
                    <div class="flex space-x-3">
                        <button onclick="filterUsers('all')" id="filter-all" 
                                class="bg-blue-500/20 text-blue-400 px-4 py-2 rounded-lg font-medium transition-all duration-300">
                            All
                        </button>
                        <button onclick="filterUsers('approved')" id="filter-approved"
                                class="bg-green-500/20 text-green-400 px-4 py-2 rounded-lg font-medium transition-all duration-300">
                            Approved
                        </button>
                        <button onclick="filterUsers('pending')" id="filter-pending"
                                class="bg-yellow-500/20 text-yellow-400 px-4 py-2 rounded-lg font-medium transition-all duration-300">
                            Pending
                        </button>
                    </div>
                </div>

                <!-- Table Header -->
                <div class="hidden md:grid grid-cols-7 gap-4 mb-4 p-4 bg-white/10 rounded-lg">
                    <div class="text-white/80 font-medium">ID</div>
                    <div class="text-white/80 font-medium">Username</div>
                    <div class="text-white/80 font-medium">Email</div>
                    <div class="text-white/80 font-medium">Age</div>
                    <div class="text-white/80 font-medium">Gender</div>
                    <div class="text-white/80 font-medium">Status</div>
                    <div class="text-white/80 font-medium">Actions</div>
                </div>

                <!-- Users List -->
                <div class="space-y-4">
                    {% for user in data %}
                        <div class="user-row bg-white/5 hover:bg-white/10 rounded-lg p-4 transition-all duration-300" 
                             data-status="{{ (user.user_status or 'Pending').lower() }}"

                            <!-- Desktop View -->
                            <div class="hidden md:grid grid-cols-7 gap-4 items-center">
                                <div class="text-white font-medium">#{{ user.id }}</div>
                                <div class="text-white">{{ user.username }}</div>
                                <div class="text-white/80 text-sm">{{ user.email }}</div>
                                <div class="text-white/80">{{ user.age }}</div>
                                <div class="text-white/80">{{ user.gender }}</div>
                                <div>
                                    <span class="px-3 py-1 rounded-full text-sm font-medium
                                           {% if user.user_status == 'approved' %}bg-green-500/20 text-green-400
                                           {% else %}bg-yellow-500/20 text-yellow-400{% endif %}">
                                        {{ user.user_status|title }}
                                    </span>
                                </div>
                                <div>
                                    <button onclick="deleteUser({{ user.id }})" 
                                            class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-3 py-2 rounded-lg font-medium transition-all duration-300 inline-flex items-center">
                                        <i class="fas fa-trash mr-1"></i>
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Mobile View -->
                        <div class="md:hidden">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="text-white font-semibold">{{ user.username }}</h4>
                                    <p class="text-white/60 text-sm">{{ user.email }}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium
                                           {% if user.user_status == 'approved' %}bg-green-500/20 text-green-400
                                           {% else %}bg-yellow-500/20 text-yellow-400{% endif %}">
                                        {{ user.user_status|title }}
                                    </span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <div class="text-white/80 text-sm">
                                    Age: {{ user.age }} | {{ user.gender }} | {{ user.mobile }}
                                </div>
                                <button onclick="deleteUser({{ user.id }})" 
                                        class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-3 py-1 rounded-lg text-sm transition-all duration-300">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="text-center slide-in">
                <div class="glass-effect rounded-3xl p-12">
                    <div class="w-24 h-24 bg-gradient-to-br from-gray-500 to-gray-600 rounded-full flex items-center justify-center mx-auto mb-6 opacity-50">
                        <i class="fas fa-users text-white text-3xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-4">No Users Found</h2>
                    <p class="text-white/80 mb-8 max-w-md mx-auto">
                        There are no registered users in the system yet.
                    </p>
                    <a href="{{ url_for('admin') }}" 
                       class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-8 py-3 rounded-xl font-semibold transition-all duration-300 inline-flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Back to Dashboard
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
</section>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full">
        <div class="text-center">
            <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-4">Confirm Deletion</h3>
            <p class="text-white/80 mb-6">Are you sure you want to delete this user? This action cannot be undone.</p>
            
            <div class="flex space-x-4">
                <button onclick="closeDeleteModal()" 
                        class="flex-1 bg-gray-500/20 hover:bg-gray-500/30 text-white py-3 rounded-xl font-semibold transition-all duration-300">
                    Cancel
                </button>
                <form id="deleteForm" method="POST" class="flex-1">
                    <button type="submit" 
                            class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-semibold transition-all duration-300">
                        Delete User
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let userToDelete = null;
    const deleteForm = document.getElementById('deleteForm');

    function deleteUser(userId) {
        userToDelete = userId;
        deleteForm.action = `/delete/${userId}/`;
        document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        userToDelete = null;
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeDeleteModal();
    });

    function filterUsers(status) {
        const rows = document.querySelectorAll('.user-row');
        const buttons = document.querySelectorAll('[id^="filter-"]');

        buttons.forEach(btn => btn.className = 'px-4 py-2 rounded-lg font-medium transition-all duration-300 text-white/60');

        const activeBtn = document.getElementById(`filter-${status}`);
        if (status === 'all') activeBtn.className = 'bg-blue-500/20 text-blue-400 px-4 py-2 rounded-lg font-medium transition-all duration-300';
        if (status === 'approved') activeBtn.className = 'bg-green-500/20 text-green-400 px-4 py-2 rounded-lg font-medium transition-all duration-300';
        if (status === 'pending') activeBtn.className = 'bg-yellow-500/20 text-yellow-400 px-4 py-2 rounded-lg font-medium transition-all duration-300';

        rows.forEach(row => {
            const userStatus = row.getAttribute('data-status');
            row.style.display = (status === 'all' || userStatus === status) ? 'block' : 'none';
        });
    }
</script>
{% endblock %}
